@{
    ViewData["Title"] = "Import Companies from Excel";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-excel"></i> Import Companies from Excel
                    </h4>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["Warning"] != null)
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            @TempData["Warning"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["Info"] != null)
                    {
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            @TempData["Info"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> Excel File Format</h5>
                        <p class="mb-2">Your Excel file should have the following columns (with or without headers):</p>
                        <ul class="mb-0">
                            <li><strong>Column 1:</strong> Company Name (required)</li>
                            <li><strong>Column 2:</strong> Email Address (optional)</li>
                            <li><strong>Column 3:</strong> Google Place ID (optional)</li>
                        </ul>
                        <hr />
                        <p class="mb-0"><strong>Example:</strong></p>
                        <table class="table table-sm table-bordered mt-2">
                            <thead>
                                <tr>
                                    <th>Company Name</th>
                                    <th>Email Address</th>
                                    <th>Place ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Acme Corporation</td>
                                    <td>contact@acme.com</td>
                                    <td>ChIJN1t_tDeuEmsRUsoyG83frY4</td>
                                </tr>
                                <tr>
                                    <td>Tech Solutions Inc</td>
                                    <td>info@techsolutions.com</td>
                                    <td>ChIJrTLr-GyuEmsRBfy61i59si0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <form asp-action="ImportFromExcel" method="post" enctype="multipart/form-data" id="importForm">
                        @Html.AntiForgeryToken()

                        <div class="mb-3" id="uploadSection">
                            <label for="excelFile" class="form-label">
                                <i class="fas fa-upload"></i> Select Excel File (.xlsx or .xls)
                            </label>
                            <input type="file" class="form-control" id="excelFile" name="excelFile" accept=".xlsx,.xls" required>
                            <div class="form-text">
                                Maximum file size: 10MB. Supports .xlsx and .xls formats.
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Note:</strong> Duplicate companies (by name or Place ID) will be automatically skipped.
                        </div>

                        <!-- Progress Section (hidden initially) -->
                        <div id="progressSection" style="display: none;">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Import Progress</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span id="progressText">Processing...</span>
                                            <span id="progressPercentage">0%</span>
                                        </div>
                                        <div class="progress" style="height: 25px;">
                                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>

                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <h4 id="totalCount">0</h4>
                                            <small class="text-muted">Total</small>
                                        </div>
                                        <div class="col-md-3">
                                            <h4 id="processedCount" class="text-primary">0</h4>
                                            <small class="text-muted">Processed</small>
                                        </div>
                                        <div class="col-md-3">
                                            <h4 id="addedCount" class="text-success">0</h4>
                                            <small class="text-muted">Added</small>
                                        </div>
                                        <div class="col-md-3">
                                            <h4 id="skippedCount" class="text-warning">0</h4>
                                            <small class="text-muted">Skipped</small>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <strong>Current:</strong> <span id="currentItem">-</span><br/>
                                            <strong>Status:</strong> <span id="statusInfo">-</span><br/>
                                            <strong>Time Remaining:</strong> <span id="timeRemaining">-</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Please keep this page open until the import is complete.
                            </div>
                        </div>

                        <div class="d-grid gap-2" id="buttonSection">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-file-import"></i> Import Companies
                            </button>
                            <a asp-action="Index" class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                        </div>

                        <div class="d-grid gap-2" id="completeSection" style="display: none;">
                            <a asp-action="Index" class="btn btn-success btn-lg">
                                <i class="fas fa-check"></i> View Companies
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle"></i> Need Help?
                    </h5>
                </div>
                <div class="card-body">
                    <h6>How to prepare your Excel file:</h6>
                    <ol>
                        <li>Open Excel or Google Sheets</li>
                        <li>Create a new spreadsheet with 3 columns</li>
                        <li>Add your company data (first row can be headers or data)</li>
                        <li>Save as .xlsx or .xls file</li>
                        <li>Upload the file using the form above</li>
                    </ol>

                    <h6 class="mt-3">Features:</h6>
                    <ul>
                        <li>Automatically skips duplicate companies</li>
                        <li>Validates file format before import</li>
                        <li>Can handle thousands of companies at once</li>
                        <li>All imported companies are marked as "Current Customers" by default</li>
                        <li>Shows detailed results after import (added/skipped counts)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let progressInterval;

document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('excelFile');
    const submitBtn = document.getElementById('submitBtn');

    if (fileInput.files.length === 0) {
        alert('Please select a file to upload.');
        return;
    }

    // Check file size (10MB limit)
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    if (fileInput.files[0].size > maxSize) {
        alert('File size exceeds 10MB. Please select a smaller file.');
        return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading and parsing file...';

    // Prepare form data
    const formData = new FormData(this);

    try {
        // Submit the form via AJAX
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (!result.success) {
            alert('Error: ' + result.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Companies';
            return;
        }

        // Hide upload section, show progress section
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('buttonSection').style.display = 'none';
        document.getElementById('progressSection').style.display = 'block';

        // Set total count
        document.getElementById('totalCount').textContent = result.totalCompanies.toLocaleString();

        // Start polling for progress
        startProgressPolling(result.sessionId);

    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while uploading the file.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Companies';
    }
});

function startProgressPolling(sessionId) {
    progressInterval = setInterval(async () => {
        try {
            const response = await fetch(`/BatchProgress/GetProgress/${sessionId}`);
            const progress = await response.json();

            updateProgressUI(progress);

            if (progress.isComplete) {
                clearInterval(progressInterval);
                onImportComplete(progress);
            }
        } catch (error) {
            console.error('Error fetching progress:', error);
        }
    }, 500); // Poll every 500ms
}

function updateProgressUI(progress) {
    const percentage = progress.totalItems > 0
        ? Math.round((progress.processedItems / progress.totalItems) * 100)
        : 0;

    // Update progress bar
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';

    // Update percentage text
    document.getElementById('progressPercentage').textContent = percentage + '%';

    // Update counts
    document.getElementById('processedCount').textContent = progress.processedItems.toLocaleString();
    document.getElementById('addedCount').textContent = progress.successfulItems.toLocaleString();
    document.getElementById('skippedCount').textContent = progress.failedItems.toLocaleString();

    // Update current item
    document.getElementById('currentItem').textContent = progress.currentItem || '-';
    document.getElementById('statusInfo').textContent = progress.rateLimitInfo || '-';

    // Update time remaining
    if (progress.estimatedRemainingSeconds > 0) {
        const minutes = Math.floor(progress.estimatedRemainingSeconds / 60);
        const seconds = progress.estimatedRemainingSeconds % 60;
        document.getElementById('timeRemaining').textContent = `${minutes}m ${seconds}s`;
    } else {
        document.getElementById('timeRemaining').textContent = '-';
    }

    // Update progress text
    document.getElementById('progressText').textContent =
        `Processing ${progress.processedItems.toLocaleString()} of ${progress.totalItems.toLocaleString()}`;

    // Change progress bar color based on status
    if (progress.status === 'Error') {
        progressBar.classList.remove('bg-primary', 'bg-success');
        progressBar.classList.add('bg-danger');
    } else if (progress.isComplete) {
        progressBar.classList.remove('bg-primary', 'progress-bar-animated');
        progressBar.classList.add('bg-success');
    }
}

function onImportComplete(progress) {
    document.getElementById('progressText').textContent = 'Import Complete!';

    if (progress.status === 'Error') {
        alert('Import failed: ' + progress.currentItem);
    } else {
        // Show complete section
        document.getElementById('completeSection').style.display = 'block';

        // Show summary
        alert(`Import completed!\n\nAdded: ${progress.successfulItems.toLocaleString()}\nSkipped: ${progress.failedItems.toLocaleString()}\nTotal: ${progress.totalItems.toLocaleString()}`);
    }
}
</script>
