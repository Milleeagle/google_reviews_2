@model List<google_reviews.Models.Company>
@{
    ViewData["Title"] = "Batch Review Management";
    var companiesWithoutReviews = ViewBag.CompaniesWithoutReviews as List<google_reviews.Models.Company>;
    var companiesWithOldReviews = ViewBag.CompaniesWithOldReviews as List<google_reviews.Models.Company>;
    var allEligibleCompanies = ViewBag.AllEligibleCompanies as List<google_reviews.Models.Company>;
    var currentLetter = ViewBag.CurrentLetter as string ?? "A";
    var availableLetters = ViewBag.AvailableLetters as List<string> ?? new List<string>();
    var totalCompaniesInLetter = (int)(ViewBag.TotalCompaniesInLetter ?? 0);
}

<!-- Alphabetical Navigation -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="card-title mb-1">
                    <i class="fas fa-filter"></i> Filter by First Letter
                    <span class="badge bg-primary">@currentLetter</span>
                </h6>
                <small class="text-muted">
                    Showing @totalCompaniesInLetter active companies with Place IDs starting with "@currentLetter"
                </small>
            </div>
        </div>
        <div class="mt-2">
            <div class="btn-group btn-group-sm flex-wrap" role="group">
                @foreach (var letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".ToCharArray())
                {
                    var hasCompanies = availableLetters.Contains(letter.ToString());
                    var isActive = letter.ToString() == currentLetter;
                    var btnClass = isActive ? "btn-primary" : (hasCompanies ? "btn-outline-primary" : "btn-outline-secondary");

                    <a href="@Url.Action("BatchReviews", new { letter = letter.ToString() })"
                       class="btn @btnClass @(!hasCompanies ? "disabled" : "")"
                       @(!hasCompanies ? "tabindex=\"-1\"" : "")>
                        @letter
                    </a>
                }
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Batch Review Management</h2>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Companies
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @TempData["Warning"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}


@if (TempData["BatchResults"] != null)
{
    var results = TempData["BatchResults"] as List<string>;
    if (results != null && results.Any())
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h6>Batch Processing Results:</h6>
            <ul class="mb-0">
                @foreach (var result in results)
                {
                    <li>@result</li>
                }
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
}

<!-- Batch ALL Reviews Section -->
<div class="card mb-4" style="border: 2px solid #0d6efd;">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-globe"></i> Batch ALL Reviews
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <h6><i class="fas fa-info-circle"></i> Process ALL Companies</h6>
            <p class="mb-2">This will refresh reviews for <strong>ALL companies</strong> in your database that have Place IDs, regardless of letter filtering.</p>
            <ul class="mb-0">
                <li>Processes all active companies with Place IDs</li>
                <li>Shows real-time progress for all companies</li>
                <li>Can handle thousands of companies efficiently</li>
            </ul>
        </div>

        <form id="batchAllForm" method="post" asp-action="StartBatchAllReviews">
            @Html.AntiForgeryToken()

            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="enableThrottling" value="true" id="enableThrottlingAll" checked>
                        <label class="form-check-label" for="enableThrottlingAll">
                            <i class="fas fa-clock"></i> <strong>Enable API Rate Limiting</strong>
                        </label>
                        <div class="form-text text-muted">
                            Throttle requests to 5000 per minute (recommended for large batches)
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="batchAllButton">
                        <i class="fas fa-rocket"></i> <strong>Batch ALL Reviews</strong>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.Any())
{
    <form asp-action="StartBatchRefresh" method="post" id="batchForm">
        <input type="hidden" name="letter" value="@currentLetter" />
        @Html.AntiForgeryToken()

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Selection Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6><i class="fas fa-filter"></i> Select by Letter</h6>
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                @foreach (var letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".ToCharArray())
                                {
                                    <button type="button" class="btn btn-outline-primary" onclick="selectByLetter('@letter')">
                                        @letter
                                    </button>
                                }
                            </div>
                        </div>

                        <hr />

                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="selectCompaniesWithoutReviews()">
                                <i class="fas fa-plus"></i> No Reviews (@companiesWithoutReviews.Count)
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="selectCompaniesWithOldReviews()">
                                <i class="fas fa-clock"></i> Old Reviews (@companiesWithOldReviews.Count)
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="selectAllEligible()">
                                <i class="fas fa-check-double"></i> All (@allEligibleCompanies.Count)
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>

                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="enableThrottling" value="true" id="enableThrottling" checked>
                                <label class="form-check-label" for="enableThrottling">
                                    <i class="fas fa-clock"></i> <strong>Enable API Rate Limiting</strong>
                                </label>
                                <div class="form-text text-muted">
                                    Throttle requests to 5000 per minute to prevent API quota limits (recommended). Unchecking allows unlimited rate but may cause 429 errors.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row mb-3">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4>Companies with Place IDs (<span id="selectedCount">0</span> selected)</h4>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-outline-success" id="refreshButton" disabled>
                            <i class="fas fa-sync-alt"></i> Refresh Selected (API)
                        </button>
                        <button type="button" class="btn btn-success" id="scrapeButton" disabled onclick="startBatchScrape()">
                            <i class="fas fa-robot"></i> Scrape Selected (FREE)
                        </button>
                        <button type="button" class="btn btn-danger" onclick="scrapeAllCompanies()">
                            <i class="fas fa-globe"></i> Scrape ALL Companies (FREE)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var company in Model)
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input company-checkbox" type="checkbox"
                                       name="selectedCompanyIds" value="@company.Id"
                                       id="company-@company.Id"
                                       data-company-name="@company.Name"
                                       data-first-letter="@company.Name.Substring(0, 1).ToUpper()"
                                       data-has-reviews="@(company.Reviews.Any() ? "true" : "false")"
                                       data-is-old="@(company.Reviews.Any() && company.LastUpdated < DateTime.UtcNow.AddDays(-7) ? "true" : "false")"
                                       onchange="updateSelection()">
                                <label class="form-check-label" for="company-@company.Id">
                                    <strong>@company.Name</strong>
                                </label>
                            </div>

                            <div class="mb-2">
                                @if (company.Reviews.Any())
                                {
                                    <span class="text-warning">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= Math.Round(company.Reviews.Average(r => r.Rating)))
                                            {
                                                <i class="fas fa-star"></i>
                                            }
                                            else
                                            {
                                                <i class="far fa-star"></i>
                                            }
                                        }
                                    </span>
                                    <small class="text-muted">
                                        (@company.Reviews.Average(r => r.Rating).ToString("F1")) - @company.Reviews.Count reviews
                                    </small>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">No Reviews</span>
                                }
                            </div>

                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i>
                                    Last updated: @company.LastUpdated.ToString("MMM dd, yyyy HH:mm")
                                    @if (company.Reviews.Any() && company.LastUpdated < DateTime.UtcNow.AddDays(-7))
                                    {
                                        <span class="badge bg-warning text-dark ms-2">Old Data</span>
                                    }
                                </small>
                            </div>

                            <small class="text-muted d-block">Place ID: @company.PlaceId</small>
                        </div>
                        <div class="card-footer">
                            <a asp-action="Company" asp-route-id="@company.Id" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </form>
}
else
{
    <div class="text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Companies Available for Batch Processing</h4>
        <p class="text-muted">Companies need to have valid Place IDs and be active to be eligible for batch review fetching.</p>
        <a asp-action="Index" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Companies
        </a>
    </div>
}

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt fa-spin"></i> Batch Processing Progress
                </h5>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Overall Progress</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">
                        <span id="processedCount">0</span> of <span id="totalCount">0</span> companies processed
                    </small>
                </div>

                <!-- Current Status -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-info-circle"></i> Current Status
                        </h6>
                        <p class="card-text mb-2">
                            <strong>Currently Processing:</strong> <span id="currentItem">Initializing...</span>
                        </p>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i> Success: <span id="successCount">0</span>
                                </small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-danger">
                                    <i class="fas fa-times-circle"></i> Failed: <span id="failedCount">0</span>
                                </small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-info">
                                    <i class="fas fa-clock"></i> ETA: <span id="estimatedTime">Calculating...</span>
                                </small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-primary">
                                    <i class="fas fa-tachometer-alt"></i> Rate: <span id="requestRate">0/min</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rate Limiting Info -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-shield-alt"></i> Rate Limiting
                        </h6>
                        <p class="card-text mb-0">
                            <span id="rateLimitInfo">Rate limiting information...</span>
                        </p>
                    </div>
                </div>

                <!-- Recent Results -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-list"></i> Recent Results
                        </h6>
                        <ul id="recentResults" class="list-unstyled mb-0" style="max-height: 200px; overflow-y: auto;">
                            <li class="text-muted">No results yet...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closeProgressModal" class="btn btn-secondary" style="display: none;">
                    Close
                </button>
                <div id="processingIndicator" class="text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Processing in progress...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function selectCompaniesWithoutReviews() {
        clearSelection();
        document.querySelectorAll('.company-checkbox[data-has-reviews="false"]').forEach(cb => {
            cb.checked = true;
        });
        updateSelection();
    }

    function selectCompaniesWithOldReviews() {
        clearSelection();
        document.querySelectorAll('.company-checkbox[data-is-old="true"]').forEach(cb => {
            cb.checked = true;
        });
        updateSelection();
    }

    function selectAllEligible() {
        document.querySelectorAll('.company-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateSelection();
    }

    function clearSelection() {
        document.querySelectorAll('.company-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateSelection();
    }

    function selectByLetter(letter) {
        clearSelection();
        document.querySelectorAll(`.company-checkbox[data-first-letter="${letter}"]`).forEach(cb => {
            cb.checked = true;
        });
        updateSelection();
    }

    async function scrapeAllCompanies() {
        // Fetch count first
        try {
            const response = await fetch('/Reviews/GetAllCompanyIds');
            const data = await response.json();

            if (!data.success) {
                alert('Error: ' + data.error);
                return;
            }

            const totalCount = data.count;
            const estimatedHours = Math.ceil(totalCount / 5 * 8 / 3600);
            const estimatedMinutes = Math.ceil((totalCount / 5 * 8 / 60) % 60);

            const confirmed = confirm(`ü§ñ SCRAPE ALL COMPANIES (FREE)\n\nThis will scrape reviews for ALL ${totalCount.toLocaleString()} companies in the database in parallel (5 at a time).\n\n‚úÖ Completely FREE - No API costs!\n‚è±Ô∏è Takes ~5-10 seconds per company\nüîÑ Runs 5 companies in parallel\n\nEstimated time: ${estimatedHours}h ${estimatedMinutes}m\n\n‚ö†Ô∏è This is a VERY large operation!\n\nDo you want to proceed?`);

            if (!confirmed) {
                return;
            }

            // Show progress modal
            const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            progressModal.show();

            // Reset progress UI
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').classList.add('progress-bar-animated');
            document.getElementById('progressBar').classList.remove('bg-success');
            document.getElementById('processingIndicator').style.display = 'block';
            document.getElementById('closeProgressModal').style.display = 'none';
            document.querySelector('#progressModal .modal-title').innerHTML = '<i class="fas fa-robot fa-spin"></i> Batch Scraping Progress (FREE)';

            // Send scrapeAll flag instead of IDs
            const formData = new FormData();
            formData.append('scrapeAll', 'true');

            const scrapeResponse = await fetch('/Reviews/StartBatchScrape', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            if (!scrapeResponse.ok) {
                throw new Error(`HTTP error! status: ${scrapeResponse.status}`);
            }

            const result = await scrapeResponse.json();
            if (result.success) {
                startProgressPolling(result.sessionId);
            } else {
                alert('Error: ' + result.error);
                const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (modal) modal.hide();
            }
        } catch (error) {
            console.error('Error starting scrape all:', error);
            alert('Error starting batch scrape. Please try again.');
        }
    }

    function updateSelection() {
        const checkedBoxes = document.querySelectorAll('.company-checkbox:checked');
        const selectedCount = checkedBoxes.length;

        document.getElementById('selectedCount').textContent = selectedCount;
        document.getElementById('refreshButton').disabled = selectedCount === 0;
        document.getElementById('scrapeButton').disabled = selectedCount === 0;

        if (selectedCount > 0) {
            document.getElementById('refreshButton').innerHTML = `<i class="fas fa-sync-alt"></i> Refresh ${selectedCount} Selected (API)`;
            document.getElementById('scrapeButton').innerHTML = `<i class="fas fa-robot"></i> Scrape ${selectedCount} Selected (FREE)`;
        } else {
            document.getElementById('refreshButton').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Selected (API)';
            document.getElementById('scrapeButton').innerHTML = '<i class="fas fa-robot"></i> Scrape Selected (FREE)';
        }
    }

    function startBatchScrape() {
        const selectedCount = document.querySelectorAll('.company-checkbox:checked').length;
        if (selectedCount === 0) {
            alert('Please select at least one company to scrape reviews.');
            return;
        }

        const confirmed = confirm(`ü§ñ FREE Web Scraping\n\nThis will scrape reviews for ${selectedCount} companies in parallel (5 at a time).\n\n‚úÖ Completely FREE - No API costs!\n‚è±Ô∏è Takes ~5-10 seconds per company\nüîÑ Runs 5 companies in parallel\n\nEstimated time: ~${Math.ceil(selectedCount / 5 * 8)} seconds\n\nDo you want to proceed?`);
        if (!confirmed) {
            return;
        }

        // Get selected company IDs
        const selectedIds = Array.from(document.querySelectorAll('.company-checkbox:checked'))
            .map(cb => cb.value);

        startBatchScrapeWithIds(selectedIds);
    }

    function startBatchScrapeWithIds(selectedIds) {
        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();

        // Reset progress UI
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').classList.add('progress-bar-animated');
        document.getElementById('progressBar').classList.remove('bg-success');
        document.getElementById('processingIndicator').style.display = 'block';
        document.getElementById('closeProgressModal').style.display = 'none';

        // Update modal title
        document.querySelector('#progressModal .modal-title').innerHTML = '<i class="fas fa-robot fa-spin"></i> Batch Scraping Progress (FREE)';

        // Submit via AJAX
        const formData = new FormData();

        selectedIds.forEach(id => {
            formData.append('selectedCompanyIds', id);
            console.log('Added company ID:', id);
        });

        console.log('Sending batch scrape request with', selectedIds.length, 'companies');
        console.log('FormData entries:', Array.from(formData.entries()));
        console.log('Full FormData:', [...formData.entries()].map(([k,v]) => `${k}=${v}`).join('&'));

        fetch('/Reviews/StartBatchScrape', {
            method: 'POST',
            body: formData,
            credentials: 'include'  // Include authentication cookies
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                startProgressPolling(data.sessionId);
            } else {
                alert('Error: ' + (data.error || 'Failed to start batch scraping'));
                const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (modal) modal.hide();
            }
        })
        .catch(error => {
            console.error('Error starting batch scrape:', error);
            alert('Error starting batch scrape: ' + error.message + '\n\nCheck browser console for details.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (modal) modal.hide();
        });
    }

    // Progress tracking using polling
    let pollingInterval;
    let currentSessionId = null;

    function startProgressPolling(sessionId) {
        currentSessionId = sessionId;
        console.log("Starting progress polling for session:", sessionId);

        // Poll every 500ms for updates
        pollingInterval = setInterval(() => {
            fetch(`/Reviews/GetBatchProgress?sessionId=${sessionId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Progress not found');
                })
                .then(progress => {
                    updateProgressUI(progress);
                    if (progress.isComplete) {
                        stopProgressPolling();
                    }
                })
                .catch(error => {
                    console.log("Progress polling stopped:", error.message);
                    stopProgressPolling();
                });
        }, 500);
    }

    function stopProgressPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    function updateProgressUI(progress) {
        const percentage = progress.totalItems > 0 ? Math.round((progress.processedItems / progress.totalItems) * 100) : 0;

        // Update progress bar
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);
        document.getElementById('progressPercentage').textContent = percentage + '%';

        // Update counts
        document.getElementById('processedCount').textContent = progress.processedItems;
        document.getElementById('totalCount').textContent = progress.totalItems;
        document.getElementById('successCount').textContent = progress.successfulItems;
        document.getElementById('failedCount').textContent = progress.failedItems;
        document.getElementById('currentItem').textContent = progress.currentItem;

        // Update rate and time estimates
        document.getElementById('requestRate').textContent = Math.round(progress.requestsPerMinute) + '/min';
        document.getElementById('rateLimitInfo').textContent = progress.rateLimitInfo;

        if (progress.estimatedRemainingSeconds > 0) {
            const minutes = Math.floor(progress.estimatedRemainingSeconds / 60);
            const seconds = progress.estimatedRemainingSeconds % 60;
            document.getElementById('estimatedTime').textContent = `${minutes}m ${seconds}s`;
        } else {
            document.getElementById('estimatedTime').textContent = progress.isComplete ? 'Completed!' : 'Calculating...';
        }

        // Update recent results
        if (progress.recentResults && progress.recentResults.length > 0) {
            const resultsList = document.getElementById('recentResults');
            resultsList.innerHTML = '';
            progress.recentResults.forEach(result => {
                const li = document.createElement('li');
                li.className = result.includes('‚úì') ? 'text-success' : 'text-danger';
                li.innerHTML = `<small>${result}</small>`;
                resultsList.appendChild(li);
            });
        }

        // Handle completion
        if (progress.isComplete) {
            document.getElementById('processingIndicator').style.display = 'none';
            document.getElementById('closeProgressModal').style.display = 'block';

            // Update progress bar color
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-success');

            // Auto-close modal after 3 seconds and refresh page
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (modal) {
                    modal.hide();
                }
                location.reload();
            }, 3000);
        }
    }

    // Batch ALL Reviews form submission
    document.getElementById('batchAllForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Always prevent default form submission

        const confirmed = confirm(`‚ö° BATCH ALL REVIEWS ‚ö°\n\nThis will refresh reviews for ALL companies in your database.\nThis may take a very long time depending on how many companies you have.\n\nAre you sure you want to continue?`);
        if (!confirmed) {
            return;
        }

        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();

        // Reset progress UI
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').classList.add('progress-bar-animated');
        document.getElementById('progressBar').classList.remove('bg-success');
        document.getElementById('processingIndicator').style.display = 'block';
        document.getElementById('closeProgressModal').style.display = 'none';

        // Update modal title for ALL companies
        document.querySelector('#progressModal .modal-title').innerHTML = '<i class="fas fa-rocket fa-spin"></i> Batch ALL Reviews Progress';

        // Submit form via AJAX to get session ID
        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                startProgressPolling(data.sessionId);
            } else {
                alert('Error: ' + (data.error || 'Failed to start batch all reviews'));
                const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (modal) modal.hide();
            }
        })
        .catch(error => {
            console.error('Error starting batch all reviews:', error);
            alert('Error starting batch all reviews. Please try again.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (modal) modal.hide();
        });
    });

    // Form submission with AJAX for letter-specific batch
    document.getElementById('batchForm')?.addEventListener('submit', function(e) {
        e.preventDefault(); // Always prevent default form submission

        const selectedCount = document.querySelectorAll('.company-checkbox:checked').length;
        if (selectedCount === 0) {
            alert('Please select at least one company to refresh reviews.');
            return;
        }

        const confirmed = confirm(`Are you sure you want to refresh reviews for ${selectedCount} companies? This will show real-time progress.`);
        if (!confirmed) {
            return;
        }

        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();

        // Reset progress UI
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').classList.add('progress-bar-animated');
        document.getElementById('progressBar').classList.remove('bg-success');
        document.getElementById('processingIndicator').style.display = 'block';
        document.getElementById('closeProgressModal').style.display = 'none';

        // Update modal title for letter-specific batch
        document.querySelector('#progressModal .modal-title').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Batch Processing Progress';

        // Submit form via AJAX to get session ID
        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                startProgressPolling(data.sessionId);
            } else {
                alert('Error: ' + (data.error || 'Failed to start batch processing'));
                const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (modal) modal.hide();
            }
        })
        .catch(error => {
            console.error('Error starting batch process:', error);
            alert('Error starting batch process. Please try again.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (modal) modal.hide();
        });
    });

    // Close progress modal handler
    document.getElementById('closeProgressModal').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
        if (modal) {
            modal.hide();
        }
        location.reload();
    });

    // Initialize selection counter on page load
    updateSelection();
</script>