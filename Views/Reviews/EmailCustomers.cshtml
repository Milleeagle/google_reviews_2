@{
    ViewData["Title"] = "Email Customers";
}

<div class="container mt-4">
    <h2 class="mb-4">üìß Send Batch Customer Outreach Emails</h2>

    <div class="alert alert-info">
        <strong>‚ÑπÔ∏è How it works:</strong>
        <ol class="mb-0">
            <li>Upload an Excel file with customer data (Company Name, Email, Google Maps URL)</li>
            <li>Configure your sender information</li>
            <li>Use <strong>Test Mode</strong> to send test emails to yourself first</li>
            <li>When ready, send to all customers</li>
        </ol>
    </div>

    <!-- Step 1: Upload Excel File -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Step 1: Upload Customer List</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">
                Excel file should have columns: <strong>Company Name</strong>, <strong>Email</strong>, <strong>Google Maps URL</strong>,
                <em>Bad Review Count (optional)</em>, <em>Average Rating (optional)</em>
            </p>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <input type="file" class="form-control" id="excelFile" name="excelFile" accept=".xlsx,.xls" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-upload"></i> Upload Customer List
                </button>
            </form>

            <div id="uploadStatus" class="mt-3"></div>
        </div>
    </div>

    <!-- Step 2: Preview and Configure (Hidden until file is uploaded) -->
    <div class="card mb-4" id="configSection" style="display: none;">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Step 2: Configure Email Settings</h5>
        </div>
        <div class="card-body">
            <div id="customerPreview" class="mb-4"></div>

            <form id="emailConfigForm">
                @Html.AntiForgeryToken()

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="senderName" class="form-label">Sender Name *</label>
                        <input type="text" class="form-control" id="senderName" name="senderName" value="Adam" required>
                    </div>
                    <div class="col-md-4">
                        <label for="senderPhone" class="form-label">Phone Number *</label>
                        <input type="text" class="form-control" id="senderPhone" name="senderPhone" placeholder="070-123 45 67" required>
                    </div>
                    <div class="col-md-4">
                        <label for="senderWebsite" class="form-label">Website *</label>
                        <input type="url" class="form-control" id="senderWebsite" name="senderWebsite" value="https://deletify.se" required>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="testMode" name="testMode">
                        <label class="form-check-label" for="testMode">
                            <strong>üß™ Test Mode</strong> - Send all emails to a test address first (recommended!)
                        </label>
                    </div>
                    <div class="mt-2" id="testEmailGroup" style="display: none;">
                        <label for="testEmail" class="form-label">Test Email Address</label>
                        <input type="email" class="form-control" id="testEmail" name="testEmail" placeholder="your-email@example.com">
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-lg btn-success" id="sendButton">
                        <i class="bi bi-send"></i> <span id="sendButtonText">Send Test Emails</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 3: Progress Tracking (Hidden until sending starts) -->
    <div class="card mb-4" id="progressSection" style="display: none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Email Campaign Progress</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="progressText">Starting...</span>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="progressBar"
                         role="progressbar"
                         style="width: 0%"></div>
                </div>
            </div>

            <div class="row text-center">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-primary" id="totalCount">0</h3>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-success" id="successCount">0</h3>
                            <small class="text-muted">Sent</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-danger" id="failCount">0</h3>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-info" id="estimatedTime">--</h3>
                            <small class="text-muted">Est. Time Left</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <small class="text-muted" id="statusInfo"></small>
            </div>

            <div id="completionMessage" class="mt-4" style="display: none;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentSessionId = null;
        let progressInterval = null;

        // Toggle test email field
        $('#testMode').change(function() {
            if ($(this).is(':checked')) {
                $('#testEmailGroup').show();
                $('#testEmail').prop('required', true);
                $('#sendButtonText').text('Send Test Emails');
            } else {
                $('#testEmailGroup').hide();
                $('#testEmail').prop('required', false);
                $('#sendButtonText').text('Send to All Customers (LIVE)');
            }
        });

        // Upload form
        $('#uploadForm').submit(function(e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('excelFile');
            formData.append('excelFile', fileInput.files[0]);

            $('#uploadStatus').html('<div class="alert alert-info">Uploading and parsing file...</div>');

            $.ajax({
                url: '/Reviews/UploadCustomerList',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $('#uploadStatus').html(`
                            <div class="alert alert-success">
                                ‚úì Successfully loaded <strong>${response.customerCount}</strong> customers
                            </div>
                        `);

                        // Show preview
                        let previewHtml = '<h6>Customer Preview:</h6><div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Company Name</th><th>Email</th><th>Bad Reviews</th></tr></thead><tbody>';
                        const previewLimit = Math.min(5, response.customers.length);
                        for (let i = 0; i < previewLimit; i++) {
                            const customer = response.customers[i];
                            previewHtml += `<tr><td>${customer.companyName}</td><td>${customer.email}</td><td>${customer.badReviewCount}</td></tr>`;
                        }
                        if (response.customers.length > 5) {
                            previewHtml += `<tr><td colspan="3" class="text-center text-muted">...and ${response.customers.length - 5} more</td></tr>`;
                        }
                        previewHtml += '</tbody></table></div>';
                        $('#customerPreview').html(previewHtml);

                        $('#configSection').slideDown();
                    } else {
                        $('#uploadStatus').html(`<div class="alert alert-danger">‚úó ${response.error}</div>`);
                    }
                },
                error: function() {
                    $('#uploadStatus').html('<div class="alert alert-danger">‚úó Error uploading file</div>');
                }
            });
        });

        // Email config form
        $('#emailConfigForm').submit(function(e) {
            e.preventDefault();

            const isTestMode = $('#testMode').is(':checked');
            const testEmail = $('#testEmail').val();

            if (isTestMode && !testEmail) {
                alert('Please enter a test email address');
                return;
            }

            if (!isTestMode) {
                if (!confirm('‚ö†Ô∏è WARNING: This will send REAL emails to ALL customers. Are you sure?')) {
                    return;
                }
            }

            const formData = {
                senderName: $('#senderName').val(),
                senderPhone: $('#senderPhone').val(),
                senderWebsite: $('#senderWebsite').val(),
                isTestMode: isTestMode,
                testEmail: testEmail
            };

            $('#sendButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');

            $.ajax({
                url: '/Reviews/SendBatchCustomerEmails',
                type: 'POST',
                data: formData,
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        currentSessionId = response.sessionId;
                        $('#configSection').slideUp();
                        $('#progressSection').slideDown();
                        $('#totalCount').text(response.totalCustomers);
                        startProgressPolling();
                    } else {
                        alert('Error: ' + response.error);
                        $('#sendButton').prop('disabled', false).html('<i class="bi bi-send"></i> <span id="sendButtonText">Send Test Emails</span>');
                    }
                },
                error: function() {
                    alert('Error starting email campaign');
                    $('#sendButton').prop('disabled', false).html('<i class="bi bi-send"></i> <span id="sendButtonText">Send Test Emails</span>');
                }
            });
        });

        function startProgressPolling() {
            progressInterval = setInterval(function() {
                $.get('/Reviews/GetBatchProgress?sessionId=' + currentSessionId, function(progress) {
                    updateProgress(progress);

                    if (progress.isComplete) {
                        clearInterval(progressInterval);
                        showCompletion(progress);
                    }
                });
            }, 1000);
        }

        function updateProgress(progress) {
            const percentage = progress.totalItems > 0
                ? Math.round((progress.processedItems / progress.totalItems) * 100)
                : 0;

            $('#progressBar').css('width', percentage + '%');
            $('#progressPercentage').text(percentage + '%');
            $('#progressText').text(progress.currentItem);
            $('#successCount').text(progress.successfulItems);
            $('#failCount').text(progress.failedItems);

            if (progress.estimatedRemainingSeconds > 0) {
                const minutes = Math.floor(progress.estimatedRemainingSeconds / 60);
                const seconds = progress.estimatedRemainingSeconds % 60;
                $('#estimatedTime').text(minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`);
            } else {
                $('#estimatedTime').text('--');
            }

            $('#statusInfo').text(progress.rateLimitInfo || '');
        }

        function showCompletion(progress) {
            $('#progressBar').removeClass('progress-bar-animated').addClass('bg-success');
            $('#progressPercentage').text('100%');

            const successRate = progress.totalItems > 0
                ? Math.round((progress.successfulItems / progress.totalItems) * 100)
                : 0;

            let alertClass = successRate === 100 ? 'alert-success' : successRate > 50 ? 'alert-warning' : 'alert-danger';

            $('#completionMessage').html(`
                <div class="alert ${alertClass}">
                    <h5>Campaign Complete!</h5>
                    <p>Successfully sent: <strong>${progress.successfulItems}</strong> / ${progress.totalItems}</p>
                    <p>Failed: <strong>${progress.failedItems}</strong></p>
                    <p class="mb-0">${progress.rateLimitInfo}</p>
                </div>
            `).show();
        }
    </script>
}
